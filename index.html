<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title id="title"></title>
<style type="text/css">
#commits, #single-commit { display: none }
.commits #commits, .single-commit #single-commit { display: block }
</style>
<script type="text/javascript">
window.onload = function() {

	function ajaj(url, onload)
	{
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState === 4)
			{
				var json = JSON.parse(request.response);
				onload(json);
			}
		}
		request.open('GET', url, true);
		request.setRequestHeader('User-Agent', 'yurivkhan/literate-github');
		request.send(null);
	}

	function splitMessage(message)
	{
		return /^([^\0]*?)(?:\n{2,}([^\0]*))?$/.exec(message);
	}

	function listCommits()
	{
		document.getElementById('root').classList.add('commits');
		ajaj(base + '/commits?sha=' + branch, function(json) {
			var commits = document.getElementById('commits');
			json.forEach(function(commit) {
				var parts = splitMessage(commit.commit.message);

				var li = document.createElement('li');
				var a = document.createElement('a');
				a.textContent = parts[1];
				a.href = '?sha=' + commit.sha;
				li.appendChild(a);
				commits.appendChild(li);
			});
		});
	}

	function showCommit(sha)
	{
		document.getElementById('root').classList.add('single-commit');
		ajaj(base + '/commits/' + sha,
			function (json) {
				var parts = splitMessage(json.commit.message);
				document.getElementById('commit-summary').textContent = parts[1];
				document.getElementById('commit-message').textContent = parts[2];

				var diff = document.getElementById('diff');
				json.files.forEach(function(file) {
					var section = document.createElement('section');
					section.id = file.filename;

					var heading = document.createElement('h3');
					heading.textContent = file.filename;
					section.appendChild(heading);

					if (file.patch)
					{
						var patch = document.createElement('pre');
						patch.textContent = file.patch;
						section.appendChild(patch);
					}

					diff.appendChild(section);
				});
			});
	}

	var base = 'https://api.github.com/repos/yurivkhan/literate-github';
	var branch = 'master';

	ajaj(base, function(json) {
		document.getElementById('title').textContent = json.full_name;
		document.getElementById('description').textContent = json.description;
	});

	var searchParams = new URLSearchParams(window.location.search.replace(/^\?/, ''));
	if (searchParams.has('sha'))
	{
		showCommit(searchParams.get('sha'));
	}
	else
	{
		listCommits();
	}
}
</script>
</head>
<body id="root">
<h1 id="description"></h1>
<ul id="commits">
</ul>
<div id="single-commit">
	<h2 id="commit-summary"></h2>
	<pre id="commit-message"></pre>
	<section id="diff"></section>
</div>
</body>
</html>
